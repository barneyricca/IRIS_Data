---
title: "EMA Processing"
output: word_document
date: "2025-05-27"
---

To do:

- Last Day COPE questions appear to be [1,4] not [0,3]. 8 December 2025: Asked Alex

```{r setup}
#| include: FALSE
#| 
knitr::opts_chunk$set(echo = TRUE)

for(packageName in c("here",
                     "magrittr",
                     "purrr",
                     "tidyverse")) {
  if(!is.element(packageName,               # If package is NOT installed...
                 installed.packages()[,1])) {
    install.packages(packageName)           #  ...then install it.
  }
  library(packageName,                      # Add package to environment
          character.only=TRUE,
          quietly=TRUE,
          verbose=FALSE)
}

i_am("Scripts/EMA Processing.Rmd") # To help find all the files.

options(show.signif.stars = FALSE)          # Don't stargaze
options(digits = 3)                         # Round to 3 digits by default

```

```{r functions}
select_ampm <- function(df) {
  require(tidyverse)

  df %>% select(starts_with("ampm")) ->
    df1

  apply(df1,
        1,
        function(x)
          min(which(is.na(x) == FALSE))) ->
    dd

  rep(NA, nrow(df1)) -> time_vec

  for(index in 1:nrow(df1)) {
    unlist(df1[index, dd[index]]) -> time_vec[index]
  }

  return(time_vec)
}

select_date <- function(df) {
  require(tidyverse)
  
  df %>% 
    select(starts_with("date")) ->
    df1
  
  apply(df1,
        1,
        function(x) 
          min(which(is.na(x) == FALSE))) ->
    dd
  
  rep(NA, nrow(df1)) -> date_vec
  
  for(index in 1:nrow(df1)) {
    unlist(df1[index, dd[index]]) -> date_vec[index]
  }

  as.Date(date_vec) ->
    date_vec

  return(date_vec)
}

select_time <- function(df) {
  require(tidyverse)
  require(lubridate)

  df %>% 
    select(starts_with("scheduled_start_local")) ->
    df1
  
  apply(df1,
        1,
        function(x) 
          min(which(is.na(x) == FALSE))) ->
    dd
  
  rep(NA, nrow(df1)) -> time_vec
  
  for(index in 1:nrow(df1)) {
    unlist(df1[index, dd[index]]) -> time_vec[index]
  }

  as_datetime(time_vec) ->
    time_vec
  
  3600 * hour(time_vec) +
    60 * minute(time_vec) +
    second(time_vec) ->
    time_vec

  return(time_vec)
}

```

# Read EMA Data

```{r read_codes}
read.csv(here("Documents/IRIS codes.csv")) ->
  codes_df
```

Important notes (Updated 1 December 2025):

1. Each file has a varying number (and names) of columns, so this is hard coded. 
2. Note that the rsp_id limits must be checked as well. Currently the range of valid rsp_id is {[64400, 65000], [67000,]}  with everything not in that range assumed to be testing entries; the testing entries are removed.
3. A 13th file was added, 10952000.csv. This file is used for the last EMA session, as it has additional data. That file must be (originally) treated separately.
4. PTDI_SF was added to the Qualtic survey.

```{r read_EMA}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| 

list() -> ema_ls

dir(path = here("ema"),                     # Work in this directory
    pattern = ".csv") -> file_names         # Get the names of all .CSV files

file_names[1] ->                            # Update for new ending EMA
  last_ema_name
file_names[-1] ->
  file_names

for(index in 1:(length(file_names)/2)) {
  2 * index  -> index2                      # Morning and evening EMA have
  index2 - 1 -> index1                      #  different number of columns
  
  read_csv(file = here(paste0("ema/",
                              file_names[index1])),
           col_select = 1:47) ->
    ema_ls[[index1]]
  NULL -> attr(ema_ls[[index1]], "spec")
  paste0(ema_ls[[index1]]$rsp_id, 
         ema_ls[[index1]]$scheduled_start_local) ->
    ema_ls[[index1]]$key
  as_date(ema_ls[[index1]]$scheduled_start_local) ->
    ema_ls[[index1]]$date
  ifelse(
    str_split_i(ema_ls[[index1]]$scheduled_start_local,
                pattern = " |:",
                i = 2) < 12, "am", "pm") ->
    ema_ls[[index1]]$ampm
  
  
  read_csv(file = here(paste0("ema/",
                              file_names[index2])),
           col_select = 1:51) ->
    ema_ls[[index2]]
  NULL -> attr(ema_ls[[index2]], "spec")
  paste0(ema_ls[[index2]]$rsp_id, 
         ema_ls[[index2]]$scheduled_start_local) ->
    ema_ls[[index2]]$key
  as_date(ema_ls[[index2]]$scheduled_start_local) ->
    ema_ls[[index2]]$date
  ifelse(
    str_split_i(ema_ls[[index2]]$scheduled_start_local,
                pattern = " |:",
                i = 2) < 12, "am", "pm") ->
    ema_ls[[index2]]$ampm
}
```

```{r lastDay}

read_csv(file = here(paste0("ema/",
                            last_ema_name)),
         col_select = 1:49) ->
  ema_ls[[13]]
read_csv(file = here(paste0("ema/",
                            last_ema_name)),
         col_select = 77:78) ->
  audio_cols
  
cbind(ema_ls[[13]],
      audio_cols) ->
  ema_ls[[13]]
  
NULL -> attr(ema_ls[[13]], "spec")
paste0(ema_ls[[13]]$rsp_id, 
       ema_ls[[13]]$scheduled_start_local) ->
  ema_ls[[13]]$key
as_date(ema_ls[[13]]$scheduled_start_local) ->
  ema_ls[[13]]$date
ifelse(
  str_split_i(ema_ls[[13]]$scheduled_start_local,
              pattern = " |:",
              i = 2) < 12, "am", "pm") ->
  ema_ls[[13]]$ampm

# Not run:
# which(colnames(ema_ls[[12]]) != colnames(ema_ls[[13]]))
# [1] 33 45 46
# The last day has a _LD inserted into the column name for these three
#  Do we care? I don't know, so...
# Add a "Last Day" column to every frame, and change the last day column
#  names.

# # Add a last day marker to each data frame:
for(index in 1:length(file_names)) {        #
  FALSE ->
    ema_ls[[index]]$last_day
}
TRUE ->
  ema_ls[[13]]$last_day

# Last day PM has questions in a different order than the 6th day PM
ema_ls[[13]][c("mbl_cod", "rsp_id", "instance_id",
               "scheduled_start_local", "timezone_offset", "COPE_5",      
               "COPE_6", "COPE_4", "COPE_2", 
               "COPE_1", "COPE_3", "PANASSF_7", 
               "PANASSF_9", "PANASSF_4", "PANASSF_12", 
               "PANASSF_15", "PANASSF_14", "PANASSF_13", 
               "PANASSF_16", "PANASSF_18", "PANASSF_19", 
               "MSPSS_7", "MSPSS_10", "MSPSS_8", 
               "MSPSS_6", "MSPSS_11", "MSPSS_2", 
               "PTGISF_6", "PTGISF_10", "PTGISF_7", 
               "PTGISF_2", "PTGISF_8", "PRCS_S6_PM_LD", 
               "PROMIS_3A_1", "PROMIS_8A_1", "PSQ_2", 
               "PSQ_4", "PSQ_8", "PSQ_3", 
               "ROE_4", "ROE_2", "CSET_1", 
               "CSET_2", "CSET_8", "REC_1_S6_PM_LD_CAN_SKP_AUD",
               "REC_2_S6_PM_LD_CAN_SKP_AUD", "PTDISF_5", "PTDISF_7", 
               "PTDISF_1", "PTDISF_6", "PTDISF_3", 
               "key", "date", "ampm", 
               "last_day")] ->
  ema_ls[[13]]

colnames(ema_ls[[12]]) ->                   # Rename columns in last_day
  colnames(ema_ls[[13]])

# Rename all the recording files


```

```{r merge_EMA}
lapply(                                     # Remove the testing rsp_id
  ema_ls,    
  function(x) x %>%                         # 
    filter(rsp_id %in% codes_df$rsp_id)) ->
  ema_ls

# unique(                                       # This should be redundant, but
#   c(ema_ls[[1]]$mbl_cod, ema_ls[[2]]$mbl_cod, # check it anyway! ema_ls[[1]]
#     ema_ls[[3]]$mbl_cod, ema_ls[[4]]$mbl_cod, # should contain them all.
#     ema_ls[[5]]$mbl_cod, ema_ls[[6]]$mbl_cod,
#     ema_ls[[7]]$mbl_cod, ema_ls[[8]]$mbl_cod,
#     ema_ls[[9]]$mbl_cod, ema_ls[[10]]$mbl_cod, 
#     ema_ls[[11]]$mbl_cod, ema_ls[[12]]$mbl_cod,
#     ema_ls[[13]]$mbl_cod)) ->
#   valid_mobile_codes

save(ema_ls,
     file = here("ema/EMA List.RData"))
```

```{r ema_names}

for(index in 1:length(ema_ls)) {
  "PRCS" -> colnames(
    ema_ls[[index]])[which(startsWith(colnames(ema_ls[[index]]),"PRCS"))]
  "REC1" -> colnames(
    ema_ls[[index]])[which(startsWith(colnames(ema_ls[[index]]),"REC_1"))]
  "REC2" -> colnames(
    ema_ls[[index]])[which(startsWith(colnames(ema_ls[[index]]),"REC_2"))]
}

sort(
  unique(
    c(colnames(ema_ls[[1]]),
      colnames(ema_ls[[2]]),
      colnames(ema_ls[[3]]),
      colnames(ema_ls[[4]]),
      colnames(ema_ls[[5]]),
      colnames(ema_ls[[6]]),
      colnames(ema_ls[[7]]),
      colnames(ema_ls[[8]]),
      colnames(ema_ls[[9]]),
      colnames(ema_ls[[10]]),
      colnames(ema_ls[[11]]),
      colnames(ema_ls[[12]]),
      colnames(ema_ls[[13]])))) ->          # Redundant; same as ema_ls[[12]]
  ema_names

```

### Data Merging

```{r merge_EMA}
as.data.frame(                              # Create a data frame of the
  matrix(NA,                                #  correct size
         nrow = sum(sapply(ema_ls, nrow)),  # Sum of all of the rows of data
         ncol = length(ema_names),          # Sorted, unique names above
         dimnames = list(NULL,              # No row names
                         ema_names))) ->    # column names
  ema_df

1 ->                                        # Running count
  row_number

for(index1 in 1:length(ema_ls)) {           # For each survey
  for(index2 in 1:nrow(ema_ls[[index1]])) { # For each row in the survey
    ema_ls[[index1]][index2, ] ->           # Store in the correct [row,column]
      ema_df[row_number, colnames(ema_ls[[index1]])]
    row_number + 1 ->                       # Increment the row
      row_number
  }
}


```

Fix particular missingness:

```{r}
NA ->                                       # Skipped 1 or more EMA: COPE, CSET,
  ema_df[ema_df == -9]                      #  MSPSS, PSQ, PANAS, PTGI, ROE
NA ->                                       # Skipped LSET question(s)
  ema_df[ema_df == -1]
  
```

Check the data integrity: Are there any data outside the scale range?

```{r check_ema_values}

# These should all return integer(0) if the data meet the integrity check.

apply(
  ema_df %>%
    select(starts_with("COPE")),
  2,
  function(x) which(x > 3 | x < 0))         # COPE scale range: [0,3]

apply(
  ema_df %>%
    select(starts_with("CSET")),
  2,
  function(x) which(x > 7 | x < 1))         # CSET scale range: [1,7]

apply(
  ema_df %>%
    select(starts_with("LSEQ")),
  2,
  function(x) which(x > 100 | x < 0))

apply(
  ema_df %>%
    select(starts_with("MSPSS")),
  2,
  function(x) which(x > 7 | x < 1))

apply(
  ema_df %>%
    select(starts_with("PANASSF")),
  2,
  function(x) which(x > 5 | x < 1))

apply(
  ema_df %>%
    select(starts_with("PROMIS")),
  2,
  function(x) which(x > 5 | x < 1))

apply(
  ema_df %>%
    select(starts_with("PSQ")),
  2,
  function(x) which(x > 4 | x < 1))

apply(
  ema_df %>%
    select(starts_with("PTDI")),
  2,
  function(x) which(x > 5 | x < 0))

apply(
  ema_df %>%
    select(starts_with("PTGI")),
  2,
  function(x) which(x > 5 | x < 0))

apply(
  ema_df %>%
    select(starts_with("ROE")),
  2,
  function(x) which(x > 5 | x < 1))

```


Step 3: Put the subscale designation into the column names. (E.g. A column name of "PSQ_1" becomes "PSQ_Demands_1" and so on.)

Be careful! Find and replace is tricky because "PANASSF_1" also finds "PANASSF_10", "PANASSF_11", etc.

Some scales do not have subscales.
```{r augmentColumnNames}

# colnames(ema_df)
#  [1] "ampm"                  "COPE_1"                "COPE_2"               
#  [4] "COPE_3"                "COPE_4"                "COPE_5"               
#  [7] "COPE_6"                "CSET_1"                "CSET_2"               
# [10] "CSET_3"                "CSET_4"                "CSET_5"               
# [13] "CSET_6"                "CSET_7"                "CSET_8"               
# [16] "CSET_9"                "date"                  "instance_id"          
# [19] "key"                   "last_day"              "LSEQ_Restlessness"    
# [22] "LSEQ_Wakefulness"      "mbl_cod"               "MSPSS_1"              
# [25] "MSPSS_10"              "MSPSS_11"              "MSPSS_12"             
# [28] "MSPSS_2"               "MSPSS_3"               "MSPSS_4"              
# [31] "MSPSS_5"               "MSPSS_6"               "MSPSS_7"              
# [34] "MSPSS_8"               "MSPSS_9"               "PANASSF_1"            
# [37] "PANASSF_10"            "PANASSF_11"            "PANASSF_12"           
# [40] "PANASSF_13"            "PANASSF_14"            "PANASSF_15"           
# [43] "PANASSF_16"            "PANASSF_17"            "PANASSF_18"           
# [46] "PANASSF_19"            "PANASSF_2"             "PANASSF_20"           
# [49] "PANASSF_3"             "PANASSF_4"             "PANASSF_5"            
# [52] "PANASSF_6"             "PANASSF_7"             "PANASSF_8"            
# [55] "PANASSF_9"             "PRCS"                  "PROMIS_3A_1"          
# [58] "PROMIS_8A_1"           "PSQ_1"                 "PSQ_2"                
# [61] "PSQ_3"                 "PSQ_4"                 "PSQ_5"                
# [64] "PSQ_6"                 "PSQ_7"                 "PSQ_8"                
# [67] "PTDISF_1"              "PTDISF_10"             "PTDISF_2"             
# [70] "PTDISF_3"              "PTDISF_4"              "PTDISF_5"             
# [73] "PTDISF_6"              "PTDISF_7"              "PTDISF_8"             
# [76] "PTDISF_9"              "PTGISF_1"              "PTGISF_10"            
# [79] "PTGISF_2"              "PTGISF_3"              "PTGISF_4"             
# [82] "PTGISF_5"              "PTGISF_6"              "PTGISF_7"             
# [85] "PTGISF_8"              "PTGISF_9"              "REC1"                 
# [88] "REC2"                  "ROE_1"                 "ROE_2"                
# [91] "ROE_3"                 "ROE_4"                 "ROE_5"                
# [94] "ROE_6"                 "rsp_id"                "scheduled_start_local"
# [97] "timezone_offset"              

c("ampm",
  "COPE_Approach_1", "COPE_Approach_2", 
  "COPE_Approach_3", "COPE_Avoid_4", "COPE_Avoid_5", 
  "COPE_Avoid_6", 
  "CSET_1", "CSET_2", 
  "CSET_3", "CSET_4", "CSET_5", 
  "CSET_6", "CSET_7", "CSET_8", 
  "CSET_9", 
  "date", "instance_id", "key", "last_day",
  "LSEQ_Restlessness", "LSEQ_Wakefulness", 
  "mbl_cod", 
  "MSPSS_SigOth_1", "MSPSS_SigOth_10", "MSPSS_Family_11", 
  "MSPSS_Friends_12", "MSPSS_SigOth_2", "MSPSS_Family_3", 
  "MSPSS_Family_4", "MSPSS_SigOth_5", "MSPSS_Friends_6", 
  "MSPSS_Friends_7", "MSPSS_Family_8", "MSPSS_Friends_9", 
  "PANASSF_Positive_1", "PANASSF_Positive_10", "PANASSF_Negative_11",
  "PANASSF_Positive_12", "PANASSF_Negative_13", "PANASSF_Positive_14",
  "PANASSF_Negative_15", "PANASSF_Positive_16", "PANASSF_Positive_17",
  "PANASSF_Negative_18", "PANASSF_Positive_19", "PANASSF_Negative_2", 
  "PANASSF_Negative_20", "PANASSF_Positive_3", "PANASSF_Negative_4",
  "PANASSF_Positive_5", "PANASSF_Negative_6", "PANASSF_Negative_7",
  "PANASSF_Negative_8", "PANASSF_Positive_9", 
  "PRCS",
  "PROMIS_3A_1", "PROMIS_8A_1",
  "PSQ_Demands_1", "PSQ_NoJoy_2", "PSQ__Tension_3", "PSQ_Worries_4", 
  "PSQ_Worries_5", "PSQ_NoJoy_6", "PSQ_Tension_7", "PSQ_Demands_8", 
  "PTDISF_1", "PTDISF_10", "PTDISF_2", "PTDISF_3", "PTDISF_4", 
  "PTDISF_5", "PTDISF_6", "PTDISF_7", "PTDISF_8", "PTDISF_9",  
  "PTGISF_Life_1", "PTGISF_Relating_10", "PTGISF_Life_2",
  "PTGISF_Possibilities_3", "PTGISF_Spiritual_4", "PTGISF_Relating_5",
  "PTGISF_Possibilities_6", "PTGISF_Strength_7", "PTGISF_Spiritual_8",
  "PTGISF_Strength_9", 
  "REC1", "REC2", 
  "ROE_1", "ROE_2", "ROE_3", "ROE_4", "ROE_5", "ROE_6",
  "rsp_id", "time", "timezone_offset") ->
  colnames(ema_df)

```

Step 4: Create instance means for each scale. Can't use totals because there are different number of items for some subscales am and pm.

LSET and PROMIS are single items, so no averaging is needed.
```{r}

#
# Need to fix COPE...I don't know why the NaN...ah...not asked in the am, so
#  half are missing.
#

ema_df %>%
  mutate(COPE_Approach = rowMeans(across(contains("_Approach_")),
                                  na.rm = TRUE)) %>%
  mutate(COPE_Avoid = rowMeans(across(contains("_Avoid_")),
                               na.rm = TRUE)) %>%
  mutate(PANAS_PA = rowMeans(across(contains("_Positive_")),
                                    na.rm = TRUE)) %>%
  mutate(PANAS_NA = rowMeans(across(contains("_Negative_")),
                             na.rm = TRUE)) %>%
  mutate(CSET = rowMeans(across(contains("CSET")),
                         na.rm = TRUE)) %>%
  mutate(PTDI = rowMeans(across(starts_with("PTDISF_")),
                         na.rm = TRUE)) %>%
  mutate(PTGI_Relate = rowMeans(across(contains("_Relate_")),
                                na.rm = TRUE)) %>%
  mutate(PTGI_Relate = rowMeans(across(contains("_Spiritual_")),
                                na.rm = TRUE)) %>%
  mutate(PTGI_Relate = rowMeans(across(contains("_Possibilities_")),
                                na.rm = TRUE)) %>%
  mutate(PTGI_Life = rowMeans(across(contains("_Life_")),
                              na.rm = TRUE)) %>%
  mutate(PTGI_Strength = rowMeans(across(contains("_Strength_")),
                                  na.rm = TRUE)) %>%
  mutate(PSQ_Demands = rowMeans(across(contains("_Demands_")),
                                na.rm = TRUE)) %>%
  mutate(PSQ_Worries = rowMeans(across(contains("_Worries_")),
                                na.rm = TRUE)) %>%
  mutate(PSQ_Tension = rowMeans(across(contains("_Tension_")),
                                na.rm = TRUE)) %>%
  mutate(PSQ_NoJoy = rowMeans(across(contains("_NoJoy_")),
                              na.rm = TRUE)) %>%
  mutate(ROE = rowMeans(across(starts_with("ROE")),
                        na.rm = TRUE)) %>%
  mutate(MSPSS_SigOth = rowMeans(across(contains("_SigOth_")),
                                 na.rm = TRUE)) %>%
  mutate(MSPSS_Family = rowMeans(across(contains("_Family_")),
                                 na.rm = TRUE)) %>%
  mutate(MSPSS_Friends = rowMeans(across(contains("_Friends_")),
                                  na.rm = TRUE)) ->
  ema_df
```

```{r}
save(ema_df,
     file = here("ema/EMA Data.RData"))
```
